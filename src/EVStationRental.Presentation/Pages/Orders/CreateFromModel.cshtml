@page "{stationId:guid}/{modelId:guid}"
@model EVStationRental.Presentation.Pages.Orders.CreateFromModelModel
@{
    ViewData["Title"] = "Đặt xe";
    var vehicleImage = !string.IsNullOrWhiteSpace(Model.VehicleImageUrl)
        ? Model.VehicleImageUrl
        : Url.Content("~/imgs/usnpx-25lucidair-jmv-0709.jpg");
}

<div class="page-card booking-shell">
    <partial name="~/Pages/Shared/_Alerts.cshtml" />
    <form method="post">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
        <input type="hidden" asp-for="StationId" />
        <input type="hidden" asp-for="ModelId" />
        <input type="hidden" asp-for="Order.VehicleId" />
        <input type="hidden" asp-for="Order.StationId" />
        <input type="hidden" asp-for="Order.PaymentMethod" />

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card-panel mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div>
                            <p class="text-muted mb-1">Trạm đã chọn</p>
                            <h4 class="mb-1">@Model.Order.StationName</h4>
                            <small class="text-muted">@Model.Order.StationAddress</small>
                        </div>
                        <span class="badge @(Model.SlotAvailable ? "badge-success" : "badge-warning")">
                            @(Model.SlotAvailable ? "Có xe sẵn" : "Hết xe trong thời gian này")
                        </span>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nhận xe</label>
                            <input class="form-control" asp-for="Order.StartTime" type="datetime-local" />
                            <span class="text-danger" asp-validation-for="Order.StartTime"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Trả xe</label>
                            <input class="form-control" asp-for="Order.EndTime" type="datetime-local" />
                            <span class="text-danger" asp-validation-for="Order.EndTime"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mã khuyến mãi</label>
                            <input class="form-control" asp-for="Order.PromotionCode" placeholder="Nhập nếu có" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phương thức</label>
                            <div class="form-control bg-light">Đặt cọc 10% qua ví</div>
                        </div>
                    </div>
                    @if (!Model.SlotAvailable)
                    {
                        <div class="alert alert-info mt-3">
                            Hiện chưa có xe trống cho khung giờ này. Bạn có thể thay đổi thời gian và kiểm tra lại.
                        </div>
                    }
                </div>

                <div class="card-panel mb-4">
                    <h5 class="mb-3">Cam kết trước khi đặt xe</h5>
                    <div class="form-check mb-2">
                        <input class="form-check-input" asp-for="Order.AcceptDepositPolicy" />
                        <label class="form-check-label" asp-for="Order.AcceptDepositPolicy"></label>
                        <span class="text-danger small d-block" asp-validation-for="Order.AcceptDepositPolicy"></span>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" asp-for="Order.AcceptUsagePolicy" />
                        <label class="form-check-label" asp-for="Order.AcceptUsagePolicy"></label>
                        <span class="text-danger small d-block" asp-validation-for="Order.AcceptUsagePolicy"></span>
                    </div>
                </div>

                @{
                    var disableSubmit = !(Model.SlotAvailable && Model.HasEnoughDeposit);
                }
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline btn-pill" type="submit" asp-page-handler="Preview">
                        Kiểm tra &amp; tính phí
                    </button>
                    @if (disableSubmit)
                    {
                        <button class="btn btn-primary btn-pill disabled" type="submit" asp-page-handler="Confirm" disabled>
                            Xác nhận &amp; đặt xe
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-primary btn-pill" type="submit" asp-page-handler="Confirm">
                            Xác nhận &amp; đặt xe
                        </button>
                    }
                </div>

                @if (!Model.HasEnoughDeposit)
                {
                    <div class="alert alert-warning mt-3">
                        Ví của bạn không đủ để đặt cọc 10%. Vui lòng <a asp-page="/Wallet/Topup">nạp ví</a> trước khi đặt.
                    </div>
                }
            </div>

            <div class="col-lg-5">
                <div class="card-panel mb-4 vehicle-summary">
                    <div class="vehicle-thumb mb-3">
                        <img src="@vehicleImage" alt="Xe đề xuất" />
                    </div>
                    <h5 class="mb-1">@Model.Order.VehicleName</h5>
                    <p class="text-muted mb-3">@Model.VehicleSpecs</p>
                    <div class="small text-muted">Nhận xe: @Model.Order.StartTime:dd/MM/yyyy HH:mm</div>
                    <div class="small text-muted mb-3">Trả xe: @Model.Order.EndTime:dd/MM/yyyy HH:mm</div>
                    <div class="small text-muted">Trạm nhận: @Model.Order.StationName</div>
                    <div class="small text-muted">@Model.Order.StationAddress</div>
                </div>

                <div class="card-panel cost-summary">
                    <h5 class="mb-3">Thông tin chi phí</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Chi phí tạm tính</span>
                        <strong>@Model.Order.BasePrice.ToString("n0") ₫</strong>
                    </div>
                    @if (Model.Order.DiscountAmount > 0)
                    {
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Ưu đãi thời lượng</span>
                            <strong>-@Model.Order.DiscountAmount.ToString("n0") ₫</strong>
                        </div>
                    }
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ví hiện có</span>
                        <strong>@Model.WalletBalance.ToString("n0") ₫</strong>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng sau ưu đãi</span>
                        <strong class="text-primary">@Model.Order.TotalAfterDiscount.ToString("n0") ₫</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Đặt cọc cần thanh toán (10%)</span>
                        <strong>@Model.Order.DepositAmount.ToString("n0") ₫</strong>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>Trạng thái ví</span>
                        <span>@(Model.HasEnoughDeposit ? "Đủ để đặt cọc" : "Không đủ để đặt cọc")</span>
                    </div>
                </div>

                <div class="card-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Ưu đãi theo thời lượng</h5>
                        <span class="badge badge-info">Tự động áp dụng</span>
                    </div>
                    <div class="discount-tier-grid">
                        @for (var i = 0; i < Model.DiscountTiers.Count; i++)
                        {
                            var tier = Model.DiscountTiers[i];
                            var isActive = i == Model.ActiveTierIndex;
                            <div class="discount-tier @(isActive ? "active" : string.Empty)">
                                <div class="discount-tier__range">@tier.Range</div>
                                <div class="discount-tier__percent">@tier.Percent% OFF</div>
                                <div class="discount-tier__desc">@tier.Description</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<partial name="~/Pages/Shared/_ValidationScriptsPartial.cshtml" />
