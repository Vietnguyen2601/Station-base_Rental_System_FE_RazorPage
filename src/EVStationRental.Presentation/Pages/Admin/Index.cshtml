@page
@using System.Linq
@using EVStationRental.Presentation.Models.Admin.Dashboard
@model EVStationRental.Presentation.Pages.Admin.IndexModel
@{
    ViewData["Title"] = "Admin Dashboard";
    var summary = Model.Summary;
    var actualStatusTotal = summary.Pending + summary.Confirmed + summary.Ongoing + summary.Completed + summary.Canceled;
    var statusTotal = Math.Max(1, actualStatusTotal);
    var statusBreakdown = new[]
    {
        new { Label = "Chờ xử lý", Count = summary.Pending, Color = "#f59e0b" },
        new { Label = "Đã xác nhận", Count = summary.Confirmed, Color = "#0ea5e9" },
        new { Label = "Đang thuê", Count = summary.Ongoing, Color = "#6366f1" },
        new { Label = "Hoàn thành", Count = summary.Completed, Color = "#22c55e" },
        new { Label = "Đã huỷ", Count = summary.Canceled, Color = "#ef4444" }
    };
    decimal offset = 0;
    var donutSegments = statusBreakdown.Select(segment =>
    {
        var pct = statusTotal > 0 ? (decimal)segment.Count / statusTotal * 100 : 0;
        var data = $"{segment.Color} {offset:F2}% {(offset + pct):F2}%";
        offset += pct;
        return data;
    }).ToList();
    var donutBg = actualStatusTotal > 0 ? $"conic-gradient({string.Join(", ", donutSegments)})" : "conic-gradient(#e5e7eb 0 100%)";
    var topStationsForBars = Model.TopStations.Take(4).ToList();
}

<div class="admin-layout">
    <partial name="~/Pages/Shared/_AdminSidebar.cshtml" />
    <div class="admin-content">
        <div class="page-card mb-4">
            <h1 class="mb-1">Tổng quan hệ thống</h1>
            <p class="text-muted mb-3">Khoảng thời gian: @summary.FilterDescription</p>
            @await Html.PartialAsync("~/Pages/Shared/_DashboardFilter.cshtml", Model.FilterVm)
        </div>

        <div class="grid-cards mb-4">
            <div class="stat-card">
                <p class="stat-card__label">Tổng đơn</p>
                <div class="stat-card__value">@summary.TotalOrders</div>
                <small>Hoàn tất: @summary.Completed</small>
            </div>
            <div class="stat-card">
                <p class="stat-card__label">Đơn đang chạy</p>
                <div class="stat-card__value">@summary.Ongoing</div>
                <small>Đang chờ/xác nhận: @(summary.Pending + summary.Confirmed)</small>
            </div>
            <div class="stat-card">
                <p class="stat-card__label">Đơn huỷ</p>
                <div class="stat-card__value text-danger">@summary.Canceled</div>
            </div>
            <div class="stat-card">
                <p class="stat-card__label">Doanh thu</p>
                <div class="stat-card__value">@summary.TotalRevenue.ToString("n0") đ</div>
                <a class="btn btn-outline btn-pill btn-sm mt-2" asp-page="/Admin/Dashboard/Revenue">Chi tiết</a>
            </div>
        </div>

        <div class="grid-cards mb-4 charts-row">
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Trạng thái đơn</h5>
                    <span class="text-muted small">Tổng: @summary.TotalOrders</span>
                </div>
                <div class="chart-donut mb-3" style="background:@donutBg">
                    <div class="chart-donut__center">
                        <div class="chart-donut__value">@summary.TotalOrders</div>
                        <div class="chart-donut__label">đơn</div>
                    </div>
                </div>
                <div class="chart-legend">
                    @foreach (var item in statusBreakdown)
                    {
                        var percentDisplay = statusTotal > 0 ? (decimal)item.Count / statusTotal * 100 : 0;
                        <div class="chart-legend__item">
                            <span class="dot" style="background:@item.Color"></span>
                            <span class="label">@item.Label</span>
                            <span class="value">@item.Count (@percentDisplay:0.#%)</span>
                        </div>
                    }
                </div>
            </div>
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Top trạm theo doanh thu</h5>
                    <a class="btn btn-outline btn-pill btn-sm" asp-page="/Admin/Dashboard/Revenue">Chi tiết</a>
                </div>
                @if (!topStationsForBars.Any())
                {
                    <p class="text-muted">Chưa có dữ liệu.</p>
                }
                else
                {
                    <div class="chart-bars">
                        @foreach (var station in topStationsForBars)
                        {
                            var percent = summary.TotalRevenue > 0 ? (double)(station.TotalRevenue / summary.TotalRevenue * 100) : 0;
                            var width = percent <= 0 ? 5 : Math.Min(percent, 100);
                            <div class="chart-bar">
                                <div class="chart-bar__label">
                                    <span>@station.StationName</span>
                                    <strong>@station.TotalRevenue.ToString("n0") ₫</strong>
                                </div>
                                <div class="chart-bar__track">
                                    <div class="chart-bar__fill" style="width:@width%"></div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="page-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-0">Top trạm theo doanh thu</h5>
                    <small class="text-muted">Nguồn doanh thu chính</small>
                </div>
                <a class="btn btn-outline btn-pill btn-sm" asp-page="/Admin/Dashboard/Stations">Quản lý trạm</a>
            </div>
            <div class="table-responsive">
                <table class="table table-modern">
                    <thead>
                        <tr>
                            <th>Trạm</th>
                            <th class="text-end">Đơn</th>
                            <th class="text-end">Hoàn thành</th>
                            <th class="text-end">Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (!Model.TopStations.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Chưa có dữ liệu.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var station in Model.TopStations)
                        {
                            <tr>
                                <td>@station.StationName</td>
                                <td class="text-end">@station.TotalOrders</td>
                                <td class="text-end">@station.CompletedOrders</td>
                                <td class="text-end">@station.TotalRevenue.ToString("n0") đ</td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid-cards">
            <div class="page-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <p class="text-muted text-uppercase small mb-1">Đơn hàng</p>
                        <h4 class="mb-0">@summary.TotalOrders đơn</h4>
                    </div>
                    <a class="btn btn-primary btn-pill btn-sm" asp-page="/Admin/Dashboard/Orders">Xem chi tiết</a>
                </div>
                <p class="text-muted mb-0">Quản lý hàng đợi &amp; trạng thái đơn.</p>
            </div>
            <div class="page-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <p class="text-muted text-uppercase small mb-1">Doanh thu &amp; ví</p>
                        <h4 class="mb-0">@summary.TotalRevenue.ToString("n0") đ</h4>
                    </div>
                    <a class="btn btn-primary btn-pill btn-sm" asp-page="/Admin/Dashboard/Revenue">Xem chi tiết</a>
                </div>
                <p class="text-muted mb-0">Dòng tiền và hiệu suất thanh toán.</p>
            </div>
        </div>
    </div>
</div>
