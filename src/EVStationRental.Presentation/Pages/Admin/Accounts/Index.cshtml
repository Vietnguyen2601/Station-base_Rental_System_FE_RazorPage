@page
@model EVStationRental.Presentation.Pages.Admin.Accounts.IndexModel
@{
    ViewData["Title"] = "Accounts";
}

<h2 class="mb-3">Accounts</h2>
<partial name="~/Pages/Shared/_Alerts.cshtml" />

<form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-6">
        <label class="form-label" for="searchBox">Tìm kiếm</label>
        <input class="form-control" id="searchBox" name="q" value="@Model.Q" placeholder="Username, email hoặc role..." />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" type="submit">Lọc</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped align-middle" id="accountsTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Trạng thái</th>
                <th>Ngày tạo</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
        @if (!Model.Items.Any())
        {
            <tr>
                <td colspan="6" class="text-center text-muted">Không có tài khoản</td>
            </tr>
        }
        else
        {
            foreach (var account in Model.Items)
            {
                <tr class="account-row">
                    <td>@account.Username</td>
                    <td>@account.Email</td>
                    <td>@string.Join(", ", account.Roles)</td>
                    <td>
                        <span class="badge @(account.IsActive ? "bg-success" : "bg-secondary")">
                            @(account.IsActive ? "Active" : "Inactive")
                        </span>
                    </td>
                    <td>@account.CreatedAt:g</td>
                    <td class="text-nowrap">
                        @if (Model.Roles.Any())
                        {
                            <form method="post" asp-page-handler="UpdateRole" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="accountId" value="@account.AccountId" />
                                <div class="input-group input-group-sm">
                                    <select name="roleId" class="form-select">
                                        @foreach (var role in Model.Roles)
                                        {
                                            <option value="@role.RoleId" selected="@(string.Equals(role.RoleName, account.PrimaryRole, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">
                                                @role.RoleName
                                            </option>
                                        }
                                    </select>
                                    <button class="btn btn-outline-primary" type="submit">Lưu</button>
                                </div>
                            </form>
                        }
                        else
                        {
                            <span class="text-muted small">Không có role khả dụng</span>
                        }
                        <form method="post" asp-page-handler="Delete" asp-route-accountId="@account.AccountId" class="d-inline ms-2" onsubmit="return confirm('Xoá tài khoản này?');">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-outline-danger btn-sm" type="submit">Xoá</button>
                        </form>
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

<div id="accountsPagination" class="mt-3"></div>

@section Scripts {
    <script src="~/js/pagination.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.generatePagination) {
                window.generatePagination('#accountsPagination', '.account-row', 10, 'Prev', 'Next');
            }
        });
    </script>
}
